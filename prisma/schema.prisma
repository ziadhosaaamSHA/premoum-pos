generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum UserStatus {
  INVITED
  ACTIVE
  SUSPENDED
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum OrderType {
  DINE_IN
  TAKEAWAY
  DELIVERY
}

enum OrderStatus {
  PREPARING
  READY
  OUT
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  WALLET
  MIXED
}

enum SaleStatus {
  DRAFT
  PAID
  VOID
}

enum PurchaseStatus {
  DRAFT
  POSTED
  CANCELLED
}

enum ZoneStatus {
  ACTIVE
  INACTIVE
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

enum ShiftStatus {
  ACTIVE
  INACTIVE
}

enum PayrollType {
  SALARY
  ADVANCE
  BONUS
  DEDUCTION
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BackupStatus {
  COMPLETED
  FAILED
  RUNNING
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  fullName         String
  passwordHash     String?
  phone            String?
  avatarUrl        String?
  status           UserStatus     @default(INVITED)
  isOwner          Boolean        @default(false)
  inviteAcceptedAt DateTime?
  lastLoginAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  createdById      String?
  createdBy        User?          @relation("UserCreatedUsers", fields: [createdById], references: [id], onDelete: SetNull)
  createdUsers     User[]         @relation("UserCreatedUsers")
  userRoles        UserRole[]
  sessions         Session[]
  invitesCreated   Invite[]       @relation("InviteCreatedBy")
  invites          Invite[]       @relation("InviteTarget")
  employee         Employee?
  shiftLogsCreated ShiftLog[]     @relation("ShiftLogCreatedBy")
  ordersCreated    Order[]        @relation("OrderCreatedBy")
  salesCreated     Sale[]         @relation("SaleCreatedBy")
  expensesCreated  Expense[]      @relation("ExpenseCreatedBy")
  purchasesCreated Purchase[]     @relation("PurchaseCreatedBy")
  wastesCreated    Waste[]        @relation("WasteCreatedBy")
  backupsCreated   BackupRecord[] @relation("BackupCreatedBy")
  auditLogs        AuditLog[]     @relation("AuditLogActor")

  @@index([status, createdAt])
}

model Role {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String
  isSystem        Boolean          @default(false)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  users           UserRole[]
  invites         Invite[]
}

model Permission {
  id              String           @id @default(cuid())
  code            String           @unique
  label           String
  description     String?
  createdAt       DateTime         @default(now())
  rolePermissions RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  assignedAt   DateTime   @default(now())
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model Invite {
  id          String       @id @default(cuid())
  email       String
  tokenHash   String       @unique
  status      InviteStatus @default(PENDING)
  userId      String?
  roleId      String
  createdById String
  expiresAt   DateTime
  acceptedAt  DateTime?
  revokedAt   DateTime?
  createdAt   DateTime     @default(now())
  metadata    Json?
  user        User?        @relation("InviteTarget", fields: [userId], references: [id], onDelete: SetNull)
  role        Role         @relation(fields: [roleId], references: [id], onDelete: Restrict)
  createdBy   User         @relation("InviteCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  @@index([email])
  @@index([status, expiresAt])
}

model Session {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime  @default(now())
  revokedAt DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model Branch {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
}

model Material {
  id            String         @id @default(cuid())
  name          String         @unique
  unit          String
  cost          Decimal        @db.Decimal(12, 3)
  stock         Decimal        @db.Decimal(12, 3)
  minStock      Decimal        @db.Decimal(12, 3)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  recipeItems   RecipeItem[]
  purchaseItems PurchaseItem[]
  wasteEntries  Waste[]
}

model Product {
  id          String       @id @default(cuid())
  name        String       @unique
  categoryId  String
  price       Decimal      @db.Decimal(12, 2)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  category    Category     @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  recipeItems RecipeItem[]
  orderItems  OrderItem[]
  saleItems   SaleItem[]

  @@index([categoryId, isActive])
}

model RecipeItem {
  id         String   @id @default(cuid())
  productId  String
  materialId String
  quantity   Decimal  @db.Decimal(12, 3)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  material   Material @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@unique([productId, materialId])
}

model Supplier {
  id        String     @id @default(cuid())
  name      String
  phone     String?
  email     String?
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  purchases Purchase[]
}

model Purchase {
  id          String         @id @default(cuid())
  code        String         @unique
  supplierId  String
  date        DateTime       @default(now())
  total       Decimal        @db.Decimal(12, 2)
  status      PurchaseStatus @default(DRAFT)
  notes       String?
  createdById String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  supplier    Supplier       @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  createdBy   User?          @relation("PurchaseCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  items       PurchaseItem[]

  @@index([status, date])
}

model PurchaseItem {
  id         String   @id @default(cuid())
  purchaseId String
  materialId String
  quantity   Decimal  @db.Decimal(12, 3)
  unitCost   Decimal  @db.Decimal(12, 3)
  totalCost  Decimal  @db.Decimal(12, 2)
  purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  material   Material @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@index([purchaseId])
}

model Waste {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  materialId  String
  quantity    Decimal  @db.Decimal(12, 3)
  reason      String
  cost        Decimal  @db.Decimal(12, 2)
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  material    Material @relation(fields: [materialId], references: [id], onDelete: Restrict)
  createdBy   User?    @relation("WasteCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
}

model Zone {
  id        String     @id @default(cuid())
  name      String     @unique
  limitKm   Decimal    @db.Decimal(8, 2)
  fee       Decimal    @db.Decimal(12, 2)
  minOrder  Decimal    @db.Decimal(12, 2)
  status    ZoneStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  orders    Order[]
}

model TaxRate {
  id        String   @id @default(cuid())
  name      String   @unique
  rate      Decimal  @db.Decimal(5, 2)
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, isDefault])
}

model BrandingSettings {
  id             String   @id
  brandName      String
  brandTagline   String?
  logoUrl        String?
  primaryColor   String
  secondaryColor String
  backgroundColor  String   @default("#f7f3ee")
  cardColor        String   @default("#ffffff")
  borderColor      String   @default("#e6e1db")
  topbarColor      String   @default("#ffffff")
  topbarTextColor  String   @default("#1b1b1b")
  tableHeaderColor String   @default("#fbfaf8")
  tableHeaderTextColor String @default("#6b6b6b")
  backgroundOpacity Int     @default(100)
  cardOpacity       Int     @default(100)
  topbarOpacity     Int     @default(100)
  tableHeaderOpacity Int    @default(100)
  sidebarOpacity    Int     @default(100)
  sidebarColor     String   @default("#1f2a2b")
  sidebarTextColor String   @default("#f6f3ef")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model SystemSettings {
  id               String   @id
  setupCompletedAt DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Driver {
  id           String   @id @default(cuid())
  name         String
  phone        String?
  status       String
  activeOrders Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  orders       Order[]
}

model DiningTable {
  id         String   @id @default(cuid())
  name       String   @unique
  number     Int      @unique
  isOccupied Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  orders     Order[]
}

model Order {
  id           String        @id @default(cuid())
  code         String        @unique
  type         OrderType
  status       OrderStatus   @default(PREPARING)
  customerName String
  zoneId       String?
  driverId     String?
  tableId      String?
  discount     Decimal       @default(0) @db.Decimal(12, 2)
  taxRate      Decimal       @default(0) @db.Decimal(5, 2)
  taxAmount    Decimal       @default(0) @db.Decimal(12, 2)
  payment      PaymentMethod @default(CASH)
  notes        String?
  receiptSnapshot Json?
  createdById  String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  zone         Zone?         @relation(fields: [zoneId], references: [id], onDelete: SetNull)
  driver       Driver?       @relation(fields: [driverId], references: [id], onDelete: SetNull)
  table        DiningTable?  @relation(fields: [tableId], references: [id], onDelete: SetNull)
  createdBy    User?         @relation("OrderCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  items        OrderItem[]
  sale         Sale?

  @@index([status, createdAt])
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  productId  String?
  quantity   Int
  unitPrice  Decimal  @db.Decimal(12, 2)
  totalPrice Decimal  @db.Decimal(12, 2)
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([orderId])
}

model Sale {
  id           String     @id @default(cuid())
  invoiceNo    String     @unique
  orderId      String?    @unique
  date         DateTime   @default(now())
  customerName String
  total        Decimal    @db.Decimal(12, 2)
  status       SaleStatus @default(DRAFT)
  notes        String?
  createdById  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  order        Order?     @relation(fields: [orderId], references: [id], onDelete: SetNull)
  createdBy    User?      @relation("SaleCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  items        SaleItem[]

  @@index([status, date])
}

model SaleItem {
  id         String   @id @default(cuid())
  saleId     String
  productId  String?
  name       String
  quantity   Int
  unitPrice  Decimal  @db.Decimal(12, 2)
  totalPrice Decimal  @db.Decimal(12, 2)
  sale       Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product    Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([saleId])
}

model Expense {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  title       String
  vendor      String?
  amount      Decimal  @db.Decimal(12, 2)
  notes       String?
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User?    @relation("ExpenseCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
}

model Employee {
  id             String         @id @default(cuid())
  userId         String?        @unique
  name           String
  roleTitle      String
  phone          String?
  status         EmployeeStatus @default(ACTIVE)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  attendances    Attendance[]
  shiftLogs      ShiftLog[]
  payrollEntries Payroll[]
  leaves         Leave[]
}

model Attendance {
  id         String    @id @default(cuid())
  employeeId String
  checkIn    DateTime
  checkOut   DateTime?
  status     String
  notes      String?
  createdAt  DateTime  @default(now())
  employee   Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, checkIn])
}

model ShiftTemplate {
  id         String      @id @default(cuid())
  name       String
  startTime  String
  endTime    String
  staffCount Int?
  status     ShiftStatus @default(ACTIVE)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model ShiftLog {
  id              String    @id @default(cuid())
  employeeId      String
  startedAt       DateTime
  endedAt         DateTime?
  durationMinutes Int       @default(0)
  pauses          Json?
  createdById     String?
  createdAt       DateTime  @default(now())
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  createdBy       User?     @relation("ShiftLogCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([employeeId, startedAt])
}

model Payroll {
  id         String      @id @default(cuid())
  employeeId String
  type       PayrollType
  amount     Decimal     @db.Decimal(12, 2)
  date       DateTime
  note       String?
  createdAt  DateTime    @default(now())
  employee   Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, date])
}

model Leave {
  id         String      @id @default(cuid())
  employeeId String
  fromDate   DateTime
  toDate     DateTime
  status     LeaveStatus @default(PENDING)
  reason     String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  employee   Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model BackupRecord {
  id          String       @id @default(cuid())
  reference   String       @unique
  status      BackupStatus @default(COMPLETED)
  sizeBytes   Int          @default(0)
  storagePath String?
  payload     Json?
  note        String?
  createdById String?
  createdAt   DateTime     @default(now())
  restoredAt  DateTime?
  createdBy   User?        @relation("BackupCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String?
  action      String
  resource    String
  resourceId  String?
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  actor       User?    @relation("AuditLogActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([action, createdAt])
}
